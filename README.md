# 批量运行实验脚本

这个程序用于批量运行实验脚本，可以自动遍历多个参数组合并记录结果。

## 功能特点

- 支持遍历多个参数组合（model_name, prompt_type, try_times）
- 支持为每个模型单独配置支持的提示类型
- 支持多线程并行运行任务，提高执行效率
- 支持断点续测，可以从上次中断的地方继续运行
- 自动生成结果表格，直观展示各模型在不同参数下的表现
- 自动重试失败的任务
- 详细记录每个任务的运行日志
- 生成CSV格式的结果汇总
- 生成摘要报告
- 显示进度条和实时日志

## 使用方法

1. 安装依赖：

```bash
pip install pandas tqdm openpyxl
```

2. 配置模型和参数：

编辑`model_config.py`文件，根据需要调整模型和参数：

```python
# 模型配置，键是模型名称，值是该模型支持的提示类型列表
MODEL_CONFIG = {
    # OpenAI 模型
    'gpt-4o-mini': ['1_llm', '2_llm', '1_mllm', '2_mllm'],  # 支持所有提示类型
    'gpt-4o': ['1_llm', '2_llm', '1_mllm', '2_mllm'],       # 支持所有提示类型
    # 如需测试更多模型，可以在这里添加
}

# 尝试次数范围
TRY_TIMES_RANGE = range(1, 4)  # 1, 2, 3

# 默认的最大重试次数
DEFAULT_MAX_RETRIES = 10

# 默认的并行工作线程数
DEFAULT_MAX_WORKERS = 40
```

3. 运行批处理程序：

```bash
python batch_runner.py
```

## 配置文件说明

程序使用独立的配置文件`model_config.py`管理所有模型和参数，方便集中调整：

- `MODEL_CONFIG`: 模型和提示类型配置，格式为{模型名: [支持的提示类型列表]}
- `TRY_TIMES_RANGE`: 每种组合的尝试次数范围
- `DEFAULT_MAX_RETRIES`: 每个任务的最大重试次数
- `DEFAULT_MAX_WORKERS`: 并行执行的线程数

当需要添加新模型或更改配置时，只需修改配置文件，不需要改动主程序代码。

## 断点续测功能

程序会自动检测之前的运行结果，并从中断的地方继续运行：

- 每次运行前，程序会读取`ladder_match_results.xlsx`文件中的已有结果
- 对于已经完成的参数组合（即表格中已有结果的单元格），程序会跳过不再重复运行
- 对于未完成的参数组合，程序会按照配置继续运行
- 结果会实时更新到表格中，方便查看进度

## 结果表格说明

程序会生成一个Excel格式的结果表格(`ladder_match_results.xlsx`)，包含以下内容：

- 行：不同的模型
- 列：不同的提示类型和尝试次数组合（如 `1_llm_try1`, `1_llm_try2` 等）
- 单元格值：模型在该参数组合下达到的层数
  - `-1`：运行出错（红色背景）
  - `0`：第一关未通过（浅红色背景）
  - `>0`：成功通过的层数（绿色背景，颜色深浅自动根据最大层数调整）

颜色渐变说明：
- 程序会自动检测所有结果中的最大层数
- 根据层数与最大层数的比例，颜色从浅绿色渐变到深绿色
- 这确保即使层数差异很大，也能直观地展示不同模型的表现差异

表格样式示例：

| 模型名称 | 1_llm_try1 | 1_llm_try2 | 2_llm_try1 | ... |
|---------|------------|------------|------------|-----|
| gpt-4o-mini | 5 | 6 | 4 | ... |
| gpt-4o | 8 | 7 | 9 | ... |

## 并行运行说明

程序使用`ThreadPoolExecutor`来并行运行多个任务，可以在配置文件中调整`DEFAULT_MAX_WORKERS`参数：

- 每个任务大约占用5GB内存
- 如果服务器有200GB可用内存，理论上可以设置最多40个并行线程
- 为了稳定性，建议根据服务器实际资源情况调整线程数

## 输出内容

程序会在`batch_results/[运行ID]/`目录下生成以下文件：

- `[model_name]_[prompt_type]_try[try_times].log`: 每个任务的详细日志
- `results.csv`: 所有任务的运行结果汇总（CSV格式）
- `summary.txt`: 运行摘要报告

同时，程序还会在控制台显示实时进度，以及在`batch_run.log`中记录全局日志。

## 结果分析

运行完成后，可以通过查看以下文件分析执行结果：

1. `ladder_match_results.xlsx`: 直观展示各模型在不同参数下的表现
2. `results.csv`: 包含以下字段的详细运行记录
   - model_name: 模型名称
   - prompt_type: 提示类型
   - try_times: 尝试次数参数
   - rank: 达到的层数
   - start_time: 开始时间
   - end_time: 结束时间
   - success: 是否成功
   - attempts: 实际尝试次数
   - log_file: 日志文件路径

## 自定义扩展

如需添加更多参数或修改命令格式，可以编辑以下文件：
- `model_config.py`: 修改模型配置和全局参数
- `batch_runner.py`: 修改主程序逻辑和命令生成方式

## 注意事项

- 确保有足够的磁盘空间存储日志和结果
- 对于长时间运行的任务，建议在后台运行（使用`nohup`或`screen`）
- 如有大量任务，可以考虑调整配置文件中的`DEFAULT_MAX_WORKERS`参数以平衡执行速度和资源使用